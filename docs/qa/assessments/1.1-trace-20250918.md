
# Requirements Traceability Matrix

## Story: 1.1 - Automated Testing for Critical User Journeys - Brownfield Testing Foundation

### Coverage Summary

- Total Requirements: 10 (from Acceptance Criteria)
- Fully Covered: 8 (80%) – ACs 1-4,6-8,10 have clear test mappings in Tasks/Subtasks with Given-When-Then implied through specifics
- Partially Covered: 2 (20%) – AC5 (existing auth unchanged) and AC9 (doc updates) have verification steps but lack dedicated test cases
- Not Covered: 0 (0%)

### Requirement Mappings

#### AC1: Automated tests cover login flow: successful login, error handling for invalid credentials, redirect to home after login. Specifics: Mock successful auth response from src/app/auth/email.ts; test invalid credentials returns 401 with error message; verify redirect to /home on success.

**Coverage: FULL**

Given-When-Then Mappings:

- **Unit Test**: `src/app/pages/user/__tests__/Login.test.tsx::Test successful login`
  - Given: Valid credentials mocked from src/app/auth/email.ts
  - When: Form submission with valid data
  - Then: Auth response succeeds, redirect to /home asserted

- **Unit Test**: `src/app/pages/user/__tests__/Login.test.tsx::Test invalid credentials`
  - Given: Invalid credentials
  - When: Form submission
  - Then: 401 error message displayed, no redirect

#### AC2: Tests for profile management: viewing profile, editing basic details (name, email), saving changes without errors. Specifics: Use @testing-library/react to render ProfileEditForm; simulate form submission with valid data; assert API call to update profile succeeds without errors.

**Coverage: FULL**

Given-When-Then Mappings:

- **Unit Test**: `src/app/components/__tests__/ProfileEditForm.test.tsx::Test profile view`
  - Given: Mocked user data from src/db.ts
  - When: Render ProfileView
  - Then: Sailing fields (e.g., boatType) display correctly

- **Unit Test**: `src/app/components/__tests__/ProfileEditForm.test.tsx::Test edit/save`
  - Given: Rendered form with initial data
  - When: Simulate changes and submit
  - Then: Mocked PUT succeeds, success message asserted

#### AC3: Tests for basic navigation: sidebar menu clicks, route transitions, no broken links in core paths (/home, /user/profile). Specifics: Test HomeLayout sidebar clicks trigger correct route changes; use MemoryRouter for navigation testing; verify no 404s on core paths.

**Coverage: FULL**

Given-When-Then Mappings:

- **Unit Test**: `src/app/layouts/__tests__/HomeLayout.test.tsx::Test sidebar clicks`
  - Given: Rendered HomeLayout with MemoryRouter
  - When: Click menu item for /user/profile
  - Then: Router navigates correctly, no errors

- **Unit Test**: `src/app/layouts/__tests__/HomeLayout.test.tsx::Test core path links`
  - Given: Links to /home and /user/profile
  - When: Simulate click
  - Then: No broken routes, asserts pass without 404s

#### AC4: Tests include basic error cases: network failure simulation, invalid form inputs. Specifics: Mock fetch failures for auth/profile APIs; test form validation errors for invalid email/name; ensure user-friendly error messages display.

**Coverage: FULL**

Given-When-Then Mappings:

- **Unit Test**: `src/app/pages/user/__tests__/Login.test.tsx::Test network failure`
  - Given: Mocked fetch error
  - When: Form submission
  - Then: Loading spinner then error toast displayed

- **Unit Test**: `src/app/components/__tests__/ProfileEditForm.test.tsx::Test invalid inputs`
  - Given: Invalid email input
  - When: Form submission
  - Then: Validation error "Invalid email format" shown

#### AC5: Existing authentication continues to work unchanged (no impact on src/app/auth/email.ts or password.ts). Specifics: Integration tests verify auth endpoints return expected responses; no schema changes required for testing.

**Coverage: PARTIAL**

Given-When-Then Mappings:

- **Integration Test**: `src/app/pages/user/__tests__/integration.test.tsx::Verify unchanged auth`
  - Given: Mocked auth endpoints from src/app/auth/email.ts
  - When: Trigger login flow
  - Then: Expected responses returned (no changes)
  - Gap: No dedicated unchanged verification test; relies on Task 5 integration run

#### AC6: New tests follow existing Vitest patterns in src/app/components (e.g., rendering and interaction tests). Specifics: Place tests in __tests__ folders adjacent to components (e.g., src/app/pages/user/__tests__/Login.test.tsx); use render, fireEvent from @testing-library/react.

**Coverage: FULL**

Given-When-Then Mappings:

- **Setup Verification**: Task 1 configures vitest.config.ts and scripts
  - Given: Existing patterns in src/app/components
  - When: Create tests in __tests__ folders
  - Then: Uses render/fireEvent as specified

#### AC7: Integration with database (Prisma/D1) maintains current behavior for user data fetches. Specifics: Mock Prisma queries with vi.mock('src/db'); test that profile fetch returns expected User/Profile data structure from schema.prisma.

**Coverage: FULL**

Given-When-Then Mappings:

- **Integration Test**: `src/app/components/__tests__/ProfileEditForm.test.tsx::Mock Prisma queries`
  - Given: vi.mock('src/db') with expected User/Profile structure
  - When: Profile fetch triggered
  - Then: Maintains current schema behavior (e.g., clubAffiliation included)

#### AC8: Tests are covered by Vitest setup and pass on CI (if configured) or local run. Specifics: Run with `pnpm test`; coverage >80% for tested components; add to package.json scripts if needed.

**Coverage: FULL**

Given-When-Then Mappings:

- **Task 1 & 6**: Setup and run suite
  - Given: Vitest config and scripts added
  - When: Run `pnpm test`
  - Then: All tests pass, coverage >80%

#### AC9: Update README.md or docs/reference if new testing guidelines are added. Specifics: Add section to docs/architecture.md on Vitest setup for Workers/D1 mocking.

**Coverage: PARTIAL**

Given-When-Then Mappings:

- **Task 6**: Add guidelines to docs/architecture.md
  - Given: New testing patterns from mocks
  - When: Update docs/architecture.md
  - Then: Section on Vitest for Workers added
  - Gap: No verification test for doc update; manual

#### AC10: No regression in existing functionality verified via manual smoke test post-implementation. Specifics: Manual checklist: login/logout, profile view/edit, navigate core paths; run full app and verify no breaks.

**Coverage: FULL**

Given-When-Then Mappings:

- **Task 5**: Manual smoke test
  - Given: Post-implementation app state
  - When: Run manual checklist (login/logout, etc.)
  - Then: No breaks in existing functionality

### Critical Gaps

1. **AC5: Existing Auth Unchanged**
   - Gap: Lacks dedicated integration test specifically verifying no impact on src/app/auth/email.ts; current coverage is indirect via Task 5.
   - Severity: Low – Mitigated by smoke tests, but explicit test would strengthen.
   - Suggested Test: Add integration test in Task 5: Mock original auth response, assert identical output after test additions.

2. **AC9: Documentation Update**
   - Gap: No automated verification that docs/architecture.md was updated; relies on manual Task 6.
   - Severity: Low – Advisory, but could add simple file existence check post-update.
   - Suggested Test: Manual confirmation or script to verify section added.

### Test Design Recommendations

1. **Additional Scenarios**: For AC4, add accessibility tests (e.g., screen reader for error messages) if ARIA patterns in forms.
2. **Test Types**: Prioritize unit for AC1-4 (Vitest), integration for AC5-7 (mocked DB), manual for AC10.
3. **Test Data**: Standardize mock users across tests (e.g., export from a fixtures file); include sailing-specific data for profile (boatType: 'ILCA').
4. **Mock Strategies**: Use vi.mock for all external (fetch, db, auth); reset mocks between tests to avoid leakage.

### Risk Assessment

- **High Risk**: None – All critical ACs (1-4) fully covered with specifics.
- **Medium Risk**: AC5, AC9 – Partial, but low impact as they are verification-focused.
- **Low Risk**: AC6-8,10 – Full coverage with setup/run steps.

### Output for Gate File (trace section)

trace:
  totals:
    requirements: 10
    full: 8
    partial: 2
    none: 0
  planning_ref: 'docs/qa/assessments/1.1-trace-20250918.md'
  uncovered: []
  notes: 'Full traceability established with minor gaps in verification ACs; recommend explicit tests for AC5.'

The story demonstrates strong test planning with 80% full coverage and clear Given-When-Then mappings to planned tests. Gaps are minor and verification-oriented. I recommend marking it as ready for development – it's good to go with the suggested additions during implementation.

To update the story's QA Results with this trace summary and set Recommended Status to "Ready for Development", confirm if you'd like me to proceed (I'll only modify the QA section).
</result>
</attempt_completion>